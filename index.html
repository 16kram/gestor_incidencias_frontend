<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de incidencias</title>
    <style>
        #en_linea {
            display: none;
            /*oculta el aviso de 'en línea'*/
        }

        #listado {
            display: none;
            /*Oculta el listado de incidencias*/
        }

        #tabla_incidencias {
            text-align: center;
            /*Centramos el texto*/
        }

        .contenedor {
            width: 100%;
            /* Ancho del espacio */
            height: 40vh;
            /* Altura del espacio */
            padding: 10px;
            /* Espacio interno */
            border: 2px solid #000;
            /* Borde del contenedor */
            margin: 20px auto;
            /* Permitir scroll si la tabla es más grande que el contenedor */
            overflow: auto;
        }

        thead th {
            text-align: center;
            /*Centramos el texto*/
            position: sticky;
            /* Mantiene el encabezado fijo durante el scroll */
            top: 0;
            /* Posiciona el encabezado en la parte superior */
            background-color: #f8f8f8;
            /* Fondo para diferenciar el encabezado */
            z-index: 1;
            /* Asegura que el encabezado esté encima del contenido */
        }

        footer {
            background-color: #333;
            /* Fondo oscuro */
            color: white;
            /* Texto en blanco */
            text-align: center;
            /* Centrar el texto */
            padding: 10px 0;
            /* Espaciado interno */
            position: fixed;
            /* Fijar en la parte inferior */
            left: 0;
            /* Alinear al borde izquierdo */
            right: 0;
            /* Alinear al borde derecho */
            bottom: 0;
            /* Ubicar al fondo de la ventana */
            width: 100%;
            /* Asegurar que ocupe todo el ancho */
            z-index: 1000;
            /* Asegurar que esté por encima de otros elementos */
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script>
        const ID = 0;//Columna 'id' de la tabla
        const ESTADO = 9;//Columna 'estado' de la tabla
        var usuario, clave, jwt;

        //Iniciar aplicación
        function iniciar() {

            //Insignía 'en línea'
            var en_linea = document.getElementById("en_linea");

            //Login
            var boton = document.getElementById("boton_login");
            boton.addEventListener("click", boton_login);
            usuario = document.getElementById("usuario");
            clave = document.getElementById("clave");

            /*//Admin
            var boton_administrador = document.getElementById("boton_admin");
            boton_administrador.addEventListener("click", boton_admin);*/

            //Tabla de incidencias
            var tabla_incidencias = document.getElementById("tabla_incidencias");
            tabla_incidencias.addEventListener("click", seleccion_incidencia);

            //Añadir incidencias
            var solicitante = document.getElementById("solicitante");
            var oficina = document.getElementById("oficina");
            var servicio = document.getElementById("servicio");
            var descripcion = document.getElementById("descripcion");
            var comentarios = document.getElementById("comentarios");
            var ubicacion = document.getElementById("ubicacion");
            var planta = document.getElementById("planta");
            var departamento = document.getElementById("departamento");
            var nueva_incidencia = document.getElementById("nueva_incidencia");
            nueva_incidencia.addEventListener("click", crear_incidencia);

        }

        //Autenticarse
        function boton_login() {
            console.log("botón pulsado");
            console.log("usuario=" + usuario.value);
            console.log("contraseña=" + clave.value);
            var login = {
                username: usuario.value,
                password: clave.value
            };
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(login),
            };
            fetch('http://localhost:8080/usuario/login', options)
                .then(data => {
                    if (!data.ok) {
                        en_linea.style.display = 'none';//Se oculta 'en línea'
                        throw Error(data.status);
                    }
                    return data.json();
                }).then(token => {
                    jwt = token;
                    console.log(jwt.token);
                    en_linea.style.display = 'inline';//Se muestra 'en línea'
                    listar_incidencias();
                }).catch(e => {
                    console.log(e);
                });
        }

        // Listar incidencias
        async function listar_incidencias() {
            console.log("botón listar incidencias");
            var datos = [];
            const mi_token = "Bearer " + jwt.token;
            try {
                let response = await fetch('http://localhost:8080/incidencias/listar', {
                    method: 'GET',
                    headers: {
                        "Authorization": mi_token // token
                    }
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                let data = await response.json();
                datos = data;
            } catch (error) {
                console.error('Fetch error:', error);
            }
            datos.reverse();//Se ponen las incidencias más recientes al principio de la tabla
            //Se crea la tabla de incidencias
            var tbody = document.querySelector("tbody");
            tbody.innerHTML = ""//Se borran los datos de la tabla
            for (var n = 0; n < datos.length; n++) {

                var newline_tabla = document.querySelector("tbody");
                var fila = document.createElement("tr");

                var celda = document.createElement("td");
                celda.innerText = datos[n].id;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].solicitante;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].servicio;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].descripcion;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].departamento;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].planta;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].ubicacion;
                fila.appendChild(celda);


                var celda = document.createElement("td");
                celda.innerText = datos[n].fechaInicio;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].fechaFin;
                fila.appendChild(celda);

                var celda = document.createElement("td");
                celda.innerText = datos[n].estado;
                fila.appendChild(celda);
                switch (datos[n].estado) {//Pone color en el texto de 'ESTADO'
                    case "FINALIZADA":
                        celda.style.color = "green";
                        break;
                    case "EN_CURSO":
                        celda.style.color = "yellow";
                        break;
                    case "PENDIENTE":
                        celda.style.color = "red";
                        break;
                }

                newline_tabla.appendChild(fila);
            }
            listado.style.display = 'block';//Muestra el listado de incidencias
        }


        //botón Admin
        async function boton_admin() {
            console.log("Botón admin pulsado");
            var datos = [];
            const mi_token = "Bearer " + jwt.token;
            try {
                let response = await fetch('http://localhost:8080/usuario/admin', {
                    method: 'GET',
                    headers: {
                        "Authorization": mi_token, // token
                        "Content-Type": "application/json"
                    }
                });
                if (!response.ok) {
                    throw new Error('Network response was not ok: ' + response.statusText);
                }
                let data = await response.text();
                datos = data;
            } catch (error) {
                console.error('Fetch error:', error);
                console.error(error.stack); // Para más detalles del error
            }
            console.log(datos);
        }


        //Selección de las incidencias de la tabla para cambiar el estado o ver la descripción
        async function seleccion_incidencia(event) {
            var celda = event.target;
            if (celda.tagName === 'TD') {
                var row = celda.parentNode;//Obtener la fila que contiene la celda
                var primeraCelda = row.cells[ID];//Obtener la primera celda de la fila
                var contenidoPrimeraCelda = primeraCelda.textContent;//Obtener el contenido de la primera celda
                console.log('Id de la incidencia:', contenidoPrimeraCelda);
                if (celda.cellIndex == ESTADO) {//Sólo cambia la celda de estado cuando se hace click en una columna de 'Estado'
                    //Se hace la peticion cambiar estado
                    var datos = [];
                    const mi_token = "Bearer " + jwt.token;
                    try {
                        let response = await fetch('http://localhost:8080/incidencias/modificarestado/' + contenidoPrimeraCelda, {
                            method: 'PUT',
                            headers: {
                                "Authorization": mi_token, // token
                                "Content-Type": "application/json"
                            }
                        });
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        let data = await response.text();
                        datos = data;
                    } catch (error) {
                        console.error('Fetch error:', error);
                        console.error(error.stack); // Para más detalles del error
                    }
                    console.log("Estado=" + datos);
                    //Se hace la petición obtenerEstado
                    var datos = [];
                    try {
                        let response = await fetch('http://localhost:8080/incidencias/obtenerestado/' + contenidoPrimeraCelda, {
                            method: 'GET',
                            headers: {
                                "Authorization": mi_token, // token
                                "Content-Type": "application/json"
                            }
                        });
                        if (!response.ok) {
                            throw new Error('Network response was not ok: ' + response.statusText);
                        }
                        let data = await response.text();
                        datos = data;
                    } catch (error) {
                        console.error('Fetch error:', error);
                        console.error(error.stack); // Para más detalles del error
                    }
                    console.log("Estado=" + datos);
                    listar_incidencias();
                } else {
                    //Se abre el detalle de la descripción de la incidencia
                    console.log("Se abre el detalle de la incidencia con id=" + contenidoPrimeraCelda);
                }
            }
        }

        //Crear incidencia
        function crear_incidencia() {
            console.log("Nueva incidencia");
            console.log("Solicitante=" + solicitante.value);
            console.log("Oficina=" + oficina.value);
            var incidencia = {
                solicitante: solicitante.value,
                oficina: oficina.value,
                servicio: servicio.value,
                descripcion: descripcion.value,
                comentarios: comentarios.value,
                ubicacion: ubicacion.value,
                planta: planta.value,
                departamento: departamento.value
            };
            const mi_token = "Bearer " + jwt.token;
            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    "Authorization": mi_token, // token,
                },
                body: JSON.stringify(incidencia),
            };
            fetch('http://localhost:8080/incidencias/alta', options)
                .then(data => {
                    if (!data.ok) {
                        throw Error(data.status);
                    }
                    solicitante.value = "";//Se borran los campos de nueva incidencia
                    descripcion.value = "";
                    comentarios.value = "";
                    departamento.value = "";
                    ubicacion.value = "";
                    listar_incidencias();//Se listan las incidencias
                }).then(response => {
                }).catch(e => {
                    console.log(e);
                });
        }


        window.addEventListener("load", iniciar);
    </script>
</head>

<body>
    <nav class="navbar bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand">Control de incidencias del departamento de mantenimiento</a>
            <form class="d-flex ms-auto">
                <span id="en_linea" class="badge rounded-pill text-bg-success">En línea</span>
                <input id="usuario" class="form-control me-2" type="text" placeholder="Usuario" aria-label="Usuario">
                <input id="clave" class="form-control me-2" type="password" placeholder="contraseña"
                    aria-label="Contraseña">
            </form>
            <button id="boton_login" class="btn btn-outline-success">Login</button>
        </div>
    </nav>

    </p>

    <div id="listado">
        <h5>LISTADO DE INCIDENCIAS</h5>
        <div class="contenedor">
            <table id="tabla_incidencias" border="1" class="table table-striped">
                <thead>
                    <tr>
                        <th>id</td>
                        <th>Solicitante</th>
                        <th>Servicio</th>
                        <th>Descripción</th>
                        <th>Departamento</th>
                        <th>Planta</th>
                        <th>Ubicacion</th>
                        <th>Fecha inicio</th>
                        <th>Fecha fin</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody></tbody> <!--Aquí se añaden las filas nuevas-->
            </table>
        </div>
        <div id="crear_incidencia_visible">
            <h5>CREAR INCIDENCIA</h5>
            <div class="contenedor">
                <form>
                    <div class="mb-3">
                        <label class="form-label">Solicitante</label>
                        <input type="text" class="form-control" id="solicitante">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Oficina</label>
                        <select id="oficina" class="form-control">
                            <option value="Barcelona">Barcelona</option>
                            <option value="Madrid">Madrid</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Servicio</label>
                        <select id="servicio" class="form-control">
                            <option value="Electricidad">Electricidad</option>
                            <option value="Climatización">Climatización</option>
                            <option value="Fontaneria">Fontaneria</option>
                            <option value="Ascensores">Ascensores</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripcion</label>
                        <textarea class="form-control" id="descripcion" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Comentarios</label>
                        <textarea class="form-control" id="comentarios" rows="4"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Departamento</label>
                        <input type="text" class="form-control" id="departamento">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">planta</label>
                        <select id="planta" class="form-control">
                            <option value="TB -03">TB -03</option>
                            <option value="TB -02">TB -02</option>
                            <option value="TB -01">TB -01</option>
                            <option value="TB PB">TB PB</option>
                            <option value="TB 01">TB 01</option>
                            <option value="TB 02">TB 02</option>
                            <option value="TB 03">TB 03</option>
                            <option value="TB 04">TB 04</option>
                            <option value="TB 05">TB 05</option>
                            <option value="TB 06">TB 06</option>
                            <option value="TB 07">TB 07</option>
                            <option value="TB 08">TB 08</option>
                            <option value="TB 09">TB 09</option>
                            <option value="TB 10">TB 10</option>
                            <option value="TB CUBIERTA">TB CUBIERTA</option>
                            <option value="TA -03">TA -03</option>
                            <option value="TA -02">TA -02</option>
                            <option value="TA -01">TA -01</option>
                            <option value="TA PB">TA PB</option>
                            <option value="TA 01">TA 01</option>
                            <option value="TA 02">TA 02</option>
                            <option value="TA 03">TA 03</option>
                            <option value="TA 04">TA 04</option>
                            <option value="TA 05">TA 05</option>
                            <option value="TA 06">TA 06</option>
                            <option value="TA 07">TA 07</option>
                            <option value="TA 08">TA 08</option>
                            <option value="TA 09">TA 09</option>
                            <option value=">TA 10">TA 10</option>
                            <option value="TA 11">TA 11</option>
                            <option value="TA 12">TA 12</option>
                            <option value="TA 13">TA 13</option>
                            <option value="TA 14">TA 14</option>
                            <option value="TA 15">TA 15</option>
                            <option value="TA 16">TA 16</option>
                            <option value="TA 17">TA 17</option>
                            <option value="TA CUBIERTA">TA CUBIERTA</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ubicacion</label>
                        <input type="text" class="form-control" id="ubicacion">
                    </div>
                </form>
                <button id="nueva_incidencia" class="btn btn-primary">Nueva incidencia</button>
            </div>
        </div>
        </br>
    </div>

    <footer>
        &copy; 2024 Esteban P.A.
    </footer>
</body>

</html>